{
  "applicationInsights": {
    "name": "taxexclusive-insights",
    "location": "eastus",
    "applicationType": "web",
    "retentionInDays": 90,
    "dailyDataCapInGB": 1,
    "features": {
      "enableLiveTail": true,
      "enableProfiler": true,
      "enableSnapshot": true,
      "enablePerformanceCounters": true
    }
  },
  "logAnalyticsWorkspace": {
    "name": "taxexclusive-workspace",
    "location": "eastus",
    "retentionInDays": 30,
    "dailyQuotaGb": 1
  },
  "alerts": [
    {
      "name": "taxexclusive-high-cpu",
      "description": "Alert when CPU usage is above 80%",
      "metricName": "Percentage CPU",
      "operator": "GreaterThan",
      "threshold": 80,
      "timeAggregation": "Average",
      "windowSize": "PT5M",
      "evaluationFrequency": "PT1M",
      "severity": 2
    },
    {
      "name": "taxexclusive-high-memory",
      "description": "Alert when memory usage is above 1GB",
      "metricName": "Memory working set",
      "operator": "GreaterThan",
      "threshold": 1073741824,
      "timeAggregation": "Average",
      "windowSize": "PT5M",
      "evaluationFrequency": "PT1M",
      "severity": 2
    },
    {
      "name": "taxexclusive-http-errors",
      "description": "Alert when HTTP 5xx errors occur",
      "metricName": "Http5xx",
      "operator": "GreaterThan",
      "threshold": 10,
      "timeAggregation": "Total",
      "windowSize": "PT5M",
      "evaluationFrequency": "PT1M",
      "severity": 1
    },
    {
      "name": "taxexclusive-slow-response",
      "description": "Alert when average response time is above 3 seconds",
      "metricName": "AverageResponseTime",
      "operator": "GreaterThan",
      "threshold": 3,
      "timeAggregation": "Average",
      "windowSize": "PT5M",
      "evaluationFrequency": "PT1M",
      "severity": 2
    },
    {
      "name": "taxexclusive-availability",
      "description": "Alert when availability drops below 95%",
      "metricName": "availabilityResults/availabilityPercentage",
      "operator": "LessThan",
      "threshold": 95,
      "timeAggregation": "Average",
      "windowSize": "PT15M",
      "evaluationFrequency": "PT5M",
      "severity": 1
    }
  ],
  "dashboards": [
    {
      "name": "TaxExclusive Application Dashboard",
      "tiles": [
        {
          "title": "Request Rate",
          "query": "requests | summarize count() by bin(timestamp, 5m)",
          "visualizationType": "linechart"
        },
        {
          "title": "Response Time",
          "query": "requests | summarize avg(duration) by bin(timestamp, 5m)",
          "visualizationType": "linechart"
        },
        {
          "title": "Error Rate",
          "query": "requests | where success == false | summarize count() by bin(timestamp, 5m)",
          "visualizationType": "linechart"
        },
        {
          "title": "Top Pages",
          "query": "pageViews | summarize count() by name | top 10 by count_",
          "visualizationType": "table"
        },
        {
          "title": "Browser Types",
          "query": "pageViews | summarize count() by client_Browser | top 10 by count_",
          "visualizationType": "piechart"
        },
        {
          "title": "Geographic Distribution",
          "query": "pageViews | summarize count() by client_CountryOrRegion | top 10 by count_",
          "visualizationType": "map"
        }
      ]
    }
  ],
  "availabilityTests": [
    {
      "name": "taxexclusive-availability-test",
      "url": "https://taxexclusive-app.azurewebsites.net",
      "locations": ["emea-nl-ams-azr", "us-fl-mia-edge", "apac-sg-sin-azr"],
      "frequency": 300,
      "timeout": 120,
      "expectedHttpStatusCode": 200
    }
  ],
  "kqlQueries": {
    "performance": {
      "requestTrends": "requests | summarize count(), avg(duration) by bin(timestamp, 1h) | render timechart",
      "errorAnalysis": "exceptions | summarize count() by type, bin(timestamp, 1h) | render timechart",
      "userSessions": "pageViews | summarize count() by session_Id | summarize avg(count_), max(count_), min(count_)",
      "slowRequests": "requests | where duration > 3000 | project timestamp, name, url, duration | order by duration desc"
    },
    "business": {
      "pagePopularity": "pageViews | summarize count() by name | order by count_ desc",
      "userEngagement": "pageViews | summarize users=dcount(user_Id), sessions=dcount(session_Id), views=count()",
      "conversionFunnel": "pageViews | where name in ('Home', 'Services', 'Contact', 'Appointment') | summarize count() by name"
    },
    "infrastructure": {
      "resourceUsage": "performanceCounters | where name in ('% Processor Time', 'Available Bytes') | summarize avg(value) by name, bin(timestamp, 15m)",
      "requestVolume": "requests | summarize count() by bin(timestamp, 5m) | render timechart",
      "responseTime95th": "requests | summarize percentile(duration, 95) by bin(timestamp, 5m) | render timechart"
    }
  }
}
